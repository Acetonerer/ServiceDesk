## Проект - тестовое задание "ServiceDesk"

Проект представляет собой backend часть приложения, работающего с пользовательскими
обращениями. Оно также фиксирует заявки в базе данных с возможностью их принятия сотрудниками поддержки.

## Содержание
- [Технологии](#технологии)
- [GoogleScript](#googlescript)
- [WorkResults](#workresults)
- [Эндпоинты](#эндпоинты)
- [SimpleAccess](#simpleaccess)
- [LocalAccess](#localaccess)
- [Тестирование](#тестирование)
- [Команда](#команда-проекта)

## Технологии
- Django, DRF
- PostgreSQL
- Docker
- Nginx
- SMTP

## GoogleScript
Под данный проект была создана новая почта gmail. 

Был создан фильтр TriggerMail, который для всех новых приходящих сообщений крепит ярлык.

По данному ярлыку описанный скрипт Google Script выполняет анализ почты раз в минуту.
Если он находит письма, у которых имеется ярлык TriggerMail - отправляется запрос на
вебхук с передачей массива данных по сообщениям.

## WorkResults
1) Выполнение флоу пользователя:
   - Отправка пользователем сообщений на email технической поддержки (service.desk.2077@gmail.com);
   - Получение пользователем автосообщений об изменении статуса заявки (при создании,
     взятии в работу и закрытии обращения);
   - Пользователь может получать сообщения от оператора, отправленные через API;
   - Все сообщения, которые пользователь отправляет, направляются в связанную с ним открытую заявку.
     В противном случае, если у пользователя нет открытых обращений, создается новая заявка.
2) Выполнение флоу оператора:
   - Есть возможность получения списка обращений с фильтрацией по статусу
     и сортировкой по любому полю обращения;
   - Оператор может назначить обращение на себя, при этом произойдет отправка автосообщения;
   - Оператор так же может отправлять сообщения пользователю через API;
   - Когда оператор закрывает заявку, пользователю отправляется автоответ, и следующее новое
     пользовательское сообщение создаст новое заявку.
3) Реализовано API (Swagger);
4) Написаны тесты для каждого приложения с общим покрытием, стремящимся к 80%;
5) Есть Readme.md.

## Эндпоинты
В проекте есть 3 группы эндпоинтов: для обращений, сообщений в них и операторов.

Для тестирования через Postman, Insomnia или Bruno:

1. У обращений (в swagger - requests) имеется один доступный эндпоинт - получение списка заявок:
   - Получение списка заявок:
     ```
     Метод GET
     
     url: /requests/user_requests/?status=&ordering=
     ```
     Для получения списка всех обращений в Querry ничего не нужно передавать;
     
     Для фильтрации заявок необходимо передать ?status=new, in_progress или closed;
     
     Для сортировки заявок необходимо передать ?ordering=любое поле обращения.
     
2. У сообщений (в swagger - mgs) имеется два доступных эндпоинта:
   - Получение списка сообщений
     ```
     Метод GET
     url: /mgs/requests/{request_id}/mgs/
     Для получения списка сообщений конкретной заявки нужно передать request_id (id заявки).
     ```
     
   - Отправка сообщений оператором пользователю
     ```
     Метод POST
     url: /mgs/requests/{request_id}/mgs/create
     Тело запроса:
     {
       "title": "заголовок",
       "description": "содержание письма",
       "recipient_mail": "почта получателя",
       "operator_id": 0 - id оператора
     }
     Для отправки сообщения оператором пользователю через API необходимо передать request_id (id заявки).
     ```

3. У операторов (в swagger - ops) имеется 4 доступных эндпоинта:
   - Получение списка операторов
     ```
     Метод GET
     url: /ops/support_ops/
     Позволяет получить список всех операторов.
     ```

   - Добавление оператора
     ```
     Метод POST
     url: /ops/support_ops/
     Тело запроса:
     {
       "operator_id": 2147483647,
       "operator_name": "string"
     }
     ```

   - Принятие оператором заявки в работу
     ```
     Метод POST
     url: /ops/{operator_id}/requests/{request_id}/progress/
     Для взятия обращения в работу необходимо передать id оператора и, собственно, обращения.
     ```

   - Закрытие оператором заявки
     ```
     Метод POST
     url: /ops/{operator_id}/requests/{request_id}/close/
     Для закрытия обращения необходимо передать id оператора и, собственно, обращения.
     ```
  
## Доступ к функционалу
Так как проект поднят на удалённом веб-хостинге, самым простым способом проверить его функционал будет
переход по адресу: https://servicedesk.stoutdev.ru.

На данной странице будет ссылка на документацию swagger.

Чтобы от лица пользователя создать новое обращение - нужно отправить сообщение на service.desk.2077@gmail.com.

## Локальный запуск
Для запуска проекта локально требуется выполнение чуть большего количества действий:
1) Клонируйте репозиторий командой:
   ```
   git clone https://github.com/Acetonerer/ServiceDesk
   ```
2) Создайте и активируйте виртуальное окружение командами:
   ```
   python -m venv venv

   venv\Scripts\activate
   ```
3) Установите зависимости командой:
   ```
   pip install -r requirements.txt
   ```
4) Создайте и заполните .env согласно образцу .env.sample
5) Далее, для того, чтобы локальный адрес сделать доступным извне - необходимо
   создать тоннель, например с помощью Tuna.
   Для этого нужно выполнить несколько шагов:
   ```
   1. Зарегистрироваться в tuna https://tuna.am/
   2. В cmd выполнить команду curl -sSLf https://get.tuna.am | sh
   3. В cmd выполнить командуtuna config save-token <ТОКЕН>,
      где ТОКЕН получается при регистрации 
   4. В cmd выполнить команду tuna http 8000
   ```
7) Теперь, когда тоннель создан - необходимо внести его https адрес в ALLOWED_HOSTS
8) Также, необходимо изменить url в Google Script;

   Для получения ссылки на Google Script можете обратиться ко мне в https://t.me/Aceton1;

   Теперь скрипт будет отправлять вебхук на созданный tuna тоннель, который
   в свою очередь будет редирректить на локальный сервер.

9) Соберите статик файлы командой:
    ```
    python manage.py collectstatic
    ```
10) Примените миграции командой:
    ```
    python manage.py migrate
    ```
11) Запустите локальный сервер командой:
    ```
    python manage.py runserver
    ```

## Тестирование
Тестирование проекта подразумевает выполнение шагов 1-4.
Для запуска тестов необходимо написать:
```
pytest --cov=. --cov-report=term-missing
```
Тем самым можно получить информацию о покрытии тестами всего проекта

## Командир проекта
Александр Болокан - backend developer
